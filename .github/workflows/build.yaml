name: build
on:
  push:
    branches:
    - "*"
    tags:
    - "*.*.*"

permissions:
  contents: read
  checks: write
  id-token: write

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - run: python3 scripts/check-doc-contents.py doc

  test:
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest, macos-latest-xlarge]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
    - if: startsWith(runner.os, 'Linux') || startsWith(runner.os, 'macOS')
      uses: actions/cache@v3
      with:
        path: ~/.stack
        key: test-${{ runner.os }}-${{ hashFiles('stack.yaml.lock') }}
    - if: startsWith(runner.os, 'Windows')
      uses: actions/cache@v3
      with:
        path: |
          ~\AppData\Roaming\stack
          ~\AppData\Local\Programs\stack
        key: test-${{ runner.os }}-${{ hashFiles('stack.yaml.lock') }}
    - if: startsWith(runner.os, 'Linux') || startsWith(runner.os, 'macOS')
      shell: bash
      run: |
        if command -v stack > /dev/null; then
          stack upgrade || true
        else
          curl -sSL https://get.haskellstack.org/ | sh
        fi
    - run: stack build --coverage --test --no-run-tests
    - run: stack test --coverage
      env:
        JUNIT_ENABLED: "1"
        JUNIT_OUTPUT_DIRECTORY: .test_report
        JUNIT_SUITE_NAME: dojang-spec
    - uses: mikepenz/action-junit-report@v4
      if: success() || failure()
      with:
        report_paths: ".test_report/*.xml"
        check_name: "test report"
    - uses: 8c6794b6/hpc-codecov-action@v3
      with:
        target: stack:spec
        excludes: Main,Paths_dojang
    - uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}

  build:
    strategy:
      matrix:
        os: [windows-latest, macos-latest, macos-latest-xlarge]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
    - if: startsWith(runner.os, 'macOS')
      uses: actions/cache@v3
      with:
        path: ~/.stack
        key: build-${{ runner.os }}-${{ hashFiles('stack.yaml.lock') }}
    - if: startsWith(runner.os, 'Windows')
      uses: actions/cache@v3
      with:
        path: |
          ~\AppData\Roaming\stack
          ~\AppData\Local\Programs\stack
        key: build-${{ runner.os }}-${{ hashFiles('stack.yaml.lock') }}
    - if: startsWith(runner.os, 'macOS')
      shell: bash
      run: |
        if command -v stack > /dev/null; then
          stack upgrade || true
        else
          curl -sSL https://get.haskellstack.org/ | sh
        fi
    - if: github.ref_type != 'tag'
      run: >-
        stack build
        --ghc-options=-O2
        --copy-bins
        --local-bin-path="${{ runner.temp }}/dojang-bins/"
        --ghc-options=-DDOJANG_DEV_BUILD=${{ github.run_number }}
    - if: github.ref_type == 'tag'
      run: >-
        stack build
        --ghc-options=-O2
        --flag dojang:static
        --copy-bins
        --local-bin-path="${{ runner.temp }}/dojang-bins/"
    - uses: allejo/setup-dasel@v1
    - if: startsWith(runner.os, 'macOS')
      shell: bash
      run: |
        cp ./LICENSE "$RUNNER_TEMP/dojang-bins/"
        scripts/make-dist.sh "$RUNNER_TEMP/dojang-bins/"
        mv dojang-*.tar.xz "$RUNNER_TEMP/"
    - if: startsWith(runner.os, 'Windows')
      shell: powershell
      run: |
        Copy-Item .\LICENSE $env:RUNNER_TEMP\dojang-bins\
        & scripts\make-dist.ps1 $env:RUNNER_TEMP\dojang-bins\
        Move-Item dojang-*.zip $env:RUNNER_TEMP\
    - uses: actions/upload-artifact@v3
      with:
        path: ${{ runner.temp }}/dojang-*-*-*.*

  build-linux:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
    - uses: actions/checkout@v4
    - uses: docker/setup-buildx-action@v3
    - uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ github.token }}
    - id: build-image
      if: github.ref_type != 'tag'
      uses: docker/build-push-action@v5
      with:
        push: true
        tags: |
          ghcr.io/${{ github.repository }}:git-${{ github.sha }}
        cache-from:
          type=registry,ref=ghcr.io/${{ github.repository }}:build-cache
        cache-to:
          type=registry,ref=ghcr.io/${{ github.repository }}:build-cache,mode=max
        build-args: DOJANG_DEV_BUILD=${{ github.run_number }}
    - if: github.ref_type == 'tag'
      uses: docker/build-push-action@v5
      with:
        push: true
        tags: |
          ghcr.io/${{ github.repository }}:latest
          ghcr.io/${{ github.repository }}:git-${{ github.sha }}
          ghcr.io/${{ github.repository }}:${{ github.ref_name }}
        cache-from:
          type=registry,ref=ghcr.io/${{ github.repository }}:build-cache
        cache-to:
          type=registry,ref=ghcr.io/${{ github.repository }}:build-cache,mode=max
    - uses: allejo/setup-dasel@v1
    - run: |
        mkdir -p "$RUNNER_TEMP/dojang-bins/"
        docker run "ghcr.io/$GITHUB_REPOSITORY:git-$GITHUB_SHA" \
          cat /usr/local/bin/dojang \
            > "$RUNNER_TEMP/dojang-bins/dojang"
        cp ./LICENSE "$RUNNER_TEMP/dojang-bins/"
        scripts/make-dist.sh "$RUNNER_TEMP/dojang-bins"
        mv dojang-*.tar.xz "$RUNNER_TEMP/"
      env:
        DIGEST: ${{ steps.build-image.outputs.digest }}
    - uses: actions/upload-artifact@v3
      with:
        path: ${{ runner.temp }}/dojang-*-*-*.*

  doc:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
    steps:
    - uses: actions/checkout@v4
    - run: |
        set -e
        pip install --user -r doc/requirements.txt
        mkdocs build
      env:
        TOKEN: ${{ github.token }}
    - uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ github.token }}
        publish_dir: ./site
        keep_files: true

# cSpell:ignore allejo buildx codecov dasel DDOJANG peaceiris popd pushd
# cSpell:ignore mikepenz mkdocs noreply xlarge
